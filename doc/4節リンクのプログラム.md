# 4節リンクの歩行を検討する

2足歩行の検討に使用することができて、実機に拡張可能なプログラムを作成する。

## 4節リンクモデル

`リンク`は`長さ`を持つ直線で、両端に`原点`と`反原点`がある。
リンクは原点と反原点の間に`複数のピン`を持ち、`他のリンクと繋がっている`。

接点を軸にしてリンクは`回転可能`で、`回転角度に制限`を持たせることができる。
`固定ピン`は`世界座標`上に固定されていて、座標は変更されない。
`回転不可`に設定されたピンにつながっているリンクは回転できない。

`駆動ピン`と固定ピンに設定されたピンを持つリンクは、駆動ピンを中心に自発的に自身の角度を変更して、他のリンクの座標や角度に影響を与える。

`駆動ピン`で`固定ピンではない`ピンは、駆動ピンを中心に自発的に角度と自身のピンの位置を変更して、他のリンクの座標や角度に影響を与える。
（処理が煩雑になるので、直近はこの組合せの駆動リンクを作成しない）

`固定ピン`を2つ以上持つリンクは角度や位置を変更できない固定軸となる。


<img src = 4節リンクのプログラムを検討.drawio.png>

>直近は駆動軸は世界座標に固定されて、他のリンクの動きに影響を与えるだけとする。
固定されてないリンクには駆動軸を設定しない。
実装の難易度を低くするため。

## 4節リンクモデル計算式

4節リンクの角度の計算式。
Dの角度Φは指令する。
Dを原点(0,0)として、Aは(a,0)。
余弦定理で角度を計算する。

https://math-jp.net/2018/08/26/yogenteiri-kakudo/

<img src = 4節リンクのプログラムを検討2.drawio.png>


```math
D = (0, 0) \\
A = (a, 0) \\
C = (d \cosΦ , d \sinΦ) \\
　\\
g = \sqrt{(B_x - D_x)^2 + (B_y - D_y)^2} = \sqrt{(a + d \cos Θ)^2 + (d \sin Θ)^2} \\
　\\
\cos A = \frac{a^2 + b^2 - g^2}{2ab} \\
　\\
\cosΦ_1 = \frac{a^2 + g^2 - b^2}{2ag} \\\\
　\\
\cos C = \frac{c^2 + d^2 - g^2}{2cd} \\
　\\

B = (g \cosΦ_1 , g \sinΦ_1) \\
　\\
角度を計算 \\
　\\
Φ = Φ_1 + Φ_2 \\
\angle B = 360 - Θ - \angle A - \angle C


　\\
　\\
　\\
検討中 \\
B = (a + d \cos Θ, d \sin Θ) \\
h = \sqrt{(C_x - A_x)^2 + (C_y - A_y)^2} = \sqrt{(d \cosΦ - a)^2 + (d \sinΦ)^2}
　\\
　\\
\cos B = \frac{b^2 + c^2 - h^2}{2bc} \\\\ 
　\\
　\\


```

### 4節リンクの閉回路方程式は以下のようになります

```math
AB + BC + CD + DA = 0\\

AB = (a - d * \cos Φ, 0) \\
BC = (d * \cos Φ - x, y) \\
CD = (x, y) \\
DA = (-a, 0) \\
　\\
となります。これらを代入すると、 \\
　\\
(a - d * \cos Φ) + (d * \cos Φ - x) + (x, y) + (-a, 0) = 0 \\
　\\
これを解くと、\\
x = a/2、y = \sqrt{(d^2 - (a/2)^2)} \\

4節リンクの4つの頂点の座標が求まったので、各角度も求めることができます。

角度θ = arccos((a/2) / d)
角度B = 90° - θ
角度C = 180° - θ
角度A = 360° - θ

以上が4節リンクの4つの頂点の座標と各角度を求める方法です

```


## 4節リンクのクラス図

検討レベルのクラス図。
こんな感じ？
clink,cpinの初期化をjsonでするところまではOK。親座標を継承して伝搬させる仕組みの構築。

```mermaid

classDiagram


class CFourBarLinkage_4節リンク {
  CLinkのインデックス番号
}


class CLink_リンク { 

  -float fLen:長さ

  -bool enable_drive: 駆動可能/不可能
  -float org_x,org_y: 原点座標
  -float oop_x,oop_y: 反原点座標


}

class CPin_ピン {
    -float x,y: 原点からの座標 y=0
    -CLink* : 他のリンクに繋がっている
    -bool enable_rotation : 回転可能/回転不可
    -bool is_fixed : 固定ピンである/固定ピンではない
    -bool is_drive : 駆動ピンである/駆動ピンではない
}

CLink_リンク "1"* --"1..*" CPin_ピン : composition
CFourBarLinkage_4節リンク "1"o--"1..*" CLink_リンク : Aggregation

```

https://zenn.dev/tak_uchida/articles/da583cf960e854

---

### 詳細なクラス図
```mermaid

classDiagram
class CPin {
  -offset: float
  -degree: float
  -enable_rotation: bool
  -is_fixed: bool
  -is_drive: bool
  -parent_pos: Tuple[float, float]
  +__init__(offset: float, degree: float, enable_rotation: bool, is_fixed: bool, is_drive: bool)
  +degree: float
  +degree(degree: float)
  +parent_pos: Tuple[float, float]
  +parent_pos(pos: Tuple[float, float])
  +calculate_coordinates()
  +draw(image: np.ndarray)
}

```

```
    - offset: 親オブジェクトの原点からのピンのオフセット
    - degree: 親オブジェクトの原点を中心にしたピンの回転角度
    - enable_rotation: ピンが回転できるかどうかを示すフラグ
    - is_fixed: ピンが固定されているかどうかを示すフラグ
    - is_drive: ピンがドライブピンかどうかを示すフラグ
    - parent_pos: 親オブジェクトの位置
    + __init__: コンストラクタ
    + degree: ピンの角度を取得するプロパティ
    + degree(degree: float): ピンの角度を設定するメソッド
    + parent_pos: 親オブジェクトの位置を取得するプロパティ
    + parent_pos(pos: Tuple[float, float]): 親オブジェクトの位置を設定するメソッド
    + calculate_coordinates: ピンの状態に基づいて値を計算するメソッド
    + draw(image: np.ndarray): 画像にピンを描画
```


